# details-for-CVE-2022-46505
MatrixSSL session resume bug
## 1. Description of bug

When the TLS handshake protocol **session resumes**, matrixssl fails to securely check the **SessionID** field, resulting in the misuse of an **all-zero MasterSecret** that can decrypt secret data.

## 2. Affected version

MatrixSSL 4.5.1-open and earlier

## 3. Vulnerability Type

tls resume session decryption

## 4. Bug details

The matrixssl server stores negotiated session information through a list. 

```c
static sslSessionEntry_t g_sessionTable[SSL_SESSION_TABLE_SIZE]; 
// SSL_SESSION_TABLE_SIZE is 32
```

```c
typedef struct
{
    unsigned char id[SSL_MAX_SESSION_ID_SIZE]; // 32
    unsigned char masterSecret[SSL_HS_MASTER_SIZE]; // 48
    const sslCipherSpec_t *cipher;
    unsigned char majVer;
    unsigned char minVer;
    short extendedMasterSecret;           /* was the extension used? */
    psTime_t startTime;
    int32 inUse;
    DLListEntry chronList;
} sslSessionEntry_t;
```

The first four bytes of the SessionID field are a **little-endian sequence** number ranging **from 0 to 31.** 

![Untitled](https://s3-us-west-2.amazonaws.com/secure.notion-static.com/99c4acb2-8100-4f5f-a798-9ce73be34764/Untitled.png)

Matrixssl determines whether the session is a resume session by matching the length of the session ID received with the four-byte quick index. 

However, when the storage list is initialized, MasterSecret is all zeros. 

Therefore, the malicious Client can send a **one-byte SessionID** for all-zero MasterSecret session resumption. When the server receives a single byte sessionid, the following bytes default to 0. Therefore, it can be validated and indexed to the list, and the MasterSecret corresponding to that sequence number in the list may still be 0. If this happens, we can **calculate the key and decrypt the TLS communication data.**

`./matrixssl/matrixssl.c  â€”>  int32 matrixResumeSession(ssl_t *ssl)`

![Untitled](https://s3-us-west-2.amazonaws.com/secure.notion-static.com/94bfcdf8-723b-4586-bfe4-dd56fee9cad4/Untitled.png)

![Untitled](https://s3-us-west-2.amazonaws.com/secure.notion-static.com/8e205475-ce50-4f27-9222-0c8a2db48b73/Untitled.png)

**Adding console output for debug :** 

![Untitled](https://s3-us-west-2.amazonaws.com/secure.notion-static.com/0fe37789-7b33-42ea-ade7-cf10acee0b63/Untitled.png)

**Testing result :**

![Untitled](https://s3-us-west-2.amazonaws.com/secure.notion-static.com/842fa435-c0a6-447a-9ef1-ed67e4bd6184/Untitled.png)

![Untitled](https://s3-us-west-2.amazonaws.com/secure.notion-static.com/d1b3fb5b-412b-4882-a8c3-11670efc31d9/Untitled.png)

**Use all-zero MasterSecret to decrypt !**
